<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FMV Calc">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23059669' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='40' font-family='Arial'>FMV</text></svg>">
  <title>FMV Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { 
      height: 100%; 
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }
    select, input { font-size: 16px !important; }
  </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState } = React;

    const ManualFMVCalculator = () => {
      const [oddsFormat, setOddsFormat] = useState('american');
      const [homeTeam, setHomeTeam] = useState('');
      const [awayTeam, setAwayTeam] = useState('');
      const [homeScore, setHomeScore] = useState('0');
      const [awayScore, setAwayScore] = useState('0');
      const [period, setPeriod] = useState('1st');
      const [minutes, setMinutes] = useState('');
      const [seconds, setSeconds] = useState('');
      const [homeOddsInput, setHomeOddsInput] = useState('');
      const [awayOddsInput, setAwayOddsInput] = useState('');
      const [result, setResult] = useState(null);

      const nhlTeams = [
        'ANA', 'BOS', 'BUF', 'CGY', 'CAR', 'CHI', 'COL', 'CBJ', 'DAL', 'DET', 'EDM',
        'FLA', 'LAK', 'MIN', 'MTL', 'NSH', 'NJD', 'NYI', 'NYR', 'OTT', 'PHI', 'PIT', 
        'SJS', 'SEA', 'STL', 'TBL', 'TOR', 'UTA', 'VAN', 'VGK', 'WSH', 'WPG'
      ];

      // Bernier model - realistic NHL comeback rates (lookup table)
      const BASE_WIN_PROB = {
        0: { 3600: 0.50, 2400: 0.50, 1200: 0.50, 0: 0.50 },
        1: { 3600: 0.36, 2400: 0.32, 1200: 0.25, 0: 0.00 },
        2: { 3600: 0.18, 2400: 0.14, 1200: 0.10, 0: 0.00 },
        3: { 3600: 0.08, 2400: 0.05, 1200: 0.03, 0: 0.00 },
        4: { 3600: 0.03, 2400: 0.015, 1200: 0.008, 0: 0.00 },
        5: { 3600: 0.01, 2400: 0.005, 1200: 0.002, 0: 0.00 }
      };

      const americanToProb = (odds) => {
        if (odds > 0) return 100 / (odds + 100);
        return Math.abs(odds) / (Math.abs(odds) + 100);
      };

      const probToAmerican = (prob) => {
        if (prob >= 0.5) return Math.round(-(prob * 100) / (1 - prob));
        return Math.round(((1 - prob) * 100) / prob);
      };

      const incrementScore = (team) => {
        if (team === 'home') {
          setHomeScore((prev) => String(Math.max(0, parseInt(prev || 0) + 1)));
        } else {
          setAwayScore((prev) => String(Math.max(0, parseInt(prev || 0) + 1)));
        }
      };

      const decrementScore = (team) => {
        if (team === 'home') {
          setHomeScore((prev) => String(Math.max(0, parseInt(prev || 0) - 1)));
        } else {
          setAwayScore((prev) => String(Math.max(0, parseInt(prev || 0) - 1)));
        }
      };

      const handleOddsFormatToggle = (newFormat) => {
        if (newFormat === oddsFormat) return;
        if (homeOddsInput) {
          if (newFormat === 'probability') {
            const prob = americanToProb(parseInt(homeOddsInput));
            setHomeOddsInput((prob * 100).toFixed(1));
          } else {
            const prob = parseFloat(homeOddsInput) / 100;
            setHomeOddsInput(probToAmerican(prob).toString());
          }
        }
        if (awayOddsInput) {
          if (newFormat === 'probability') {
            const prob = americanToProb(parseInt(awayOddsInput));
            setAwayOddsInput((prob * 100).toFixed(1));
          } else {
            const prob = parseFloat(awayOddsInput) / 100;
            setAwayOddsInput(probToAmerican(prob).toString());
          }
        }
        setOddsFormat(newFormat);
      };

      const interpolate = (table, seconds) => {
        const times = [3600, 2400, 1200, 0];
        for (let i = 0; i < times.length - 1; i++) {
          if (seconds <= times[i] && seconds >= times[i + 1]) {
            const ratio = (seconds - times[i + 1]) / (times[i] - times[i + 1]);
            return table[times[i + 1]] + ratio * (table[times[i]] - table[times[i + 1]]);
          }
        }
        return seconds >= 3600 ? table[3600] : table[0];
      };

      // Exponential decay model for comeback probability
      const calcExpDecayProb = (pregameProb, deficit, seconds) => {
        if (deficit === 0) return pregameProb;
        const k = 0.75; // decay coefficient
        const timeFactor = Math.sqrt(seconds / 3600);
        return pregameProb * Math.exp(-k * Math.abs(deficit) * timeFactor);
      };

      // Lookup table model with pregame adjustment
      const calcTableProb = (pregameProb, deficit, seconds) => {
        const d = Math.min(Math.abs(deficit), 5);
        const baseProb = interpolate(BASE_WIN_PROB[d], seconds);
        return Math.max(0, Math.min(1, baseProb + 0.50 * (pregameProb - 0.50)));
      };

      // Weighted aggregate of both models (70% table, 30% exponential)
      const calculateBernierWinProb = (pregameProb, deficit, secondsRemaining) => {
        if (deficit === 0) return pregameProb;
        
        const tableProb = calcTableProb(pregameProb, deficit, secondsRemaining);
        const expProb = calcExpDecayProb(pregameProb, deficit, secondsRemaining);
        
        // Weight: 70% lookup table, 30% exponential decay
        const weightedProb = 0.7 * tableProb + 0.3 * expProb;
        
        return Math.max(0.001, Math.min(0.999, weightedProb));
      };

      const calculateSecondsRemaining = (period, mins, secs) => {
        const timeLeftInPeriod = (parseInt(mins) * 60) + parseInt(secs);
        if (period === '1st') return timeLeftInPeriod + 2400;
        if (period === '2nd') return timeLeftInPeriod + 1200;
        if (period === '3rd') return timeLeftInPeriod;
        return 0;
      };

      const calculate = () => {
        if (!homeTeam || !awayTeam || homeScore === '' || awayScore === '' || minutes === '' || seconds === '' || !homeOddsInput || !awayOddsInput) {
          alert('Please fill in all fields');
          return;
        }

        let homePregameProb, awayPregameProb;
        if (oddsFormat === 'american') {
          homePregameProb = americanToProb(parseInt(homeOddsInput));
          awayPregameProb = americanToProb(parseInt(awayOddsInput));
        } else {
          homePregameProb = parseFloat(homeOddsInput) / 100;
          awayPregameProb = parseFloat(awayOddsInput) / 100;
        }

        const hScore = parseInt(homeScore);
        const aScore = parseInt(awayScore);
        const scoreDiff = hScore - aScore;
        const secondsRemaining = calculateSecondsRemaining(period, minutes, seconds);

        let currentHomeProb, currentAwayProb;
        if (scoreDiff === 0) {
          currentHomeProb = homePregameProb;
          currentAwayProb = awayPregameProb;
        } else if (scoreDiff > 0) {
          currentHomeProb = calculateBernierWinProb(homePregameProb, Math.abs(scoreDiff), secondsRemaining);
          currentAwayProb = 1 - currentHomeProb;
        } else {
          currentAwayProb = calculateBernierWinProb(awayPregameProb, Math.abs(scoreDiff), secondsRemaining);
          currentHomeProb = 1 - currentAwayProb;
        }

        const newHomeScoreDiff = (hScore + 1) - aScore;
        let homeIfScoreProb;
        if (newHomeScoreDiff === 0) homeIfScoreProb = homePregameProb;
        else if (newHomeScoreDiff > 0) homeIfScoreProb = calculateBernierWinProb(homePregameProb, Math.abs(newHomeScoreDiff), secondsRemaining);
        else homeIfScoreProb = 1 - calculateBernierWinProb(awayPregameProb, Math.abs(newHomeScoreDiff), secondsRemaining);

        const newAwayScoreDiff = hScore - (aScore + 1);
        let awayIfScoreProb;
        if (newAwayScoreDiff === 0) awayIfScoreProb = awayPregameProb;
        else if (newAwayScoreDiff < 0) awayIfScoreProb = calculateBernierWinProb(awayPregameProb, Math.abs(newAwayScoreDiff), secondsRemaining);
        else awayIfScoreProb = 1 - calculateBernierWinProb(homePregameProb, Math.abs(newAwayScoreDiff), secondsRemaining);

        setResult({
          currentHomeProb, currentAwayProb,
          currentHomeOdds: probToAmerican(currentHomeProb),
          currentAwayOdds: probToAmerican(currentAwayProb),
          homeIfScoreProb, awayIfScoreProb,
          homeIfScoreOdds: probToAmerican(homeIfScoreProb),
          awayIfScoreOdds: probToAmerican(awayIfScoreProb),
          homeIfScore_AwayProb: 1 - homeIfScoreProb,
          awayIfScore_HomeProb: 1 - awayIfScoreProb
        });
      };

      const formatOdds = (odds) => odds > 0 ? `+${odds}` : odds.toString();
      const formatProb = (prob) => `${(prob * 100).toFixed(1)}%`;

      return (
        <div className="h-screen bg-gray-900 p-2 flex flex-col">
          {/* Header */}
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-1">
              <div className="w-4 h-4 bg-emerald-500 rounded flex items-center justify-center text-white text-xs">$</div>
              <span className="text-sm font-bold text-white">FMV Calculator</span>
            </div>
            <div className="flex gap-0.5 bg-gray-700 rounded p-0.5">
              <button onClick={() => handleOddsFormatToggle('american')} className={`px-2 py-0.5 rounded text-xs ${oddsFormat === 'american' ? 'bg-emerald-600 text-white' : 'text-gray-300'}`}>Odds</button>
              <button onClick={() => handleOddsFormatToggle('probability')} className={`px-2 py-0.5 rounded text-xs ${oddsFormat === 'probability' ? 'bg-emerald-600 text-white' : 'text-gray-300'}`}>%</button>
            </div>
          </div>

          {/* Input Section */}
          <div className="bg-gray-800 rounded-lg p-2 mb-2">
            {/* Teams */}
            <div className="grid grid-cols-2 gap-2 mb-2">
              <div>
                <label className="text-[10px] text-gray-400">Away</label>
                <select value={awayTeam} onChange={(e) => setAwayTeam(e.target.value)} className="w-full py-1 px-1 bg-gray-700 text-white rounded text-xs">
                  <option value="">Team</option>
                  {nhlTeams.map(team => <option key={team} value={team}>{team}</option>)}
                </select>
              </div>
              <div>
                <label className="text-[10px] text-gray-400">Home</label>
                <select value={homeTeam} onChange={(e) => setHomeTeam(e.target.value)} className="w-full py-1 px-1 bg-gray-700 text-white rounded text-xs">
                  <option value="">Team</option>
                  {nhlTeams.map(team => <option key={team} value={team}>{team}</option>)}
                </select>
              </div>
            </div>

            {/* Odds & Scores */}
            <div className="grid grid-cols-4 gap-1 mb-2">
              <div>
                <label className="text-[10px] text-gray-400">Away Odds (Pre)</label>
                <input type="text" inputMode="numeric" value={awayOddsInput} onChange={(e) => setAwayOddsInput(e.target.value)} placeholder={oddsFormat === 'american' ? '+150' : '60'} className="w-full py-1 bg-gray-700 text-white rounded text-xs text-center" />
              </div>
              <div>
                <label className="text-[10px] text-gray-400">Away Score</label>
                <div className="flex">
                  <input type="text" inputMode="numeric" value={awayScore} onChange={(e) => setAwayScore(e.target.value)} className="w-full py-1 bg-gray-700 text-white rounded-l text-xs text-center" />
                  <div className="flex flex-col">
                    <button onClick={() => incrementScore('away')} className="px-1 bg-gray-600 text-white text-[10px] rounded-tr">▲</button>
                    <button onClick={() => decrementScore('away')} className="px-1 bg-gray-600 text-white text-[10px] rounded-br">▼</button>
                  </div>
                </div>
              </div>
              <div>
                <label className="text-[10px] text-gray-400">Home Odds (Pre)</label>
                <input type="text" inputMode="numeric" value={homeOddsInput} onChange={(e) => setHomeOddsInput(e.target.value)} placeholder={oddsFormat === 'american' ? '-150' : '40'} className="w-full py-1 bg-gray-700 text-white rounded text-xs text-center" />
              </div>
              <div>
                <label className="text-[10px] text-gray-400">Home Score</label>
                <div className="flex">
                  <input type="text" inputMode="numeric" value={homeScore} onChange={(e) => setHomeScore(e.target.value)} className="w-full py-1 bg-gray-700 text-white rounded-l text-xs text-center" />
                  <div className="flex flex-col">
                    <button onClick={() => incrementScore('home')} className="px-1 bg-gray-600 text-white text-[10px] rounded-tr">▲</button>
                    <button onClick={() => decrementScore('home')} className="px-1 bg-gray-600 text-white text-[10px] rounded-br">▼</button>
                  </div>
                </div>
              </div>
            </div>

            {/* Period & Time */}
            <div className="grid grid-cols-3 gap-1 mb-2">
              <div>
                <label className="text-[10px] text-gray-400">Period</label>
                <select value={period} onChange={(e) => setPeriod(e.target.value)} className="w-full py-1 bg-gray-700 text-white rounded text-xs text-center">
                  <option value="1st">1st</option>
                  <option value="2nd">2nd</option>
                  <option value="3rd">3rd</option>
                </select>
              </div>
              <div>
                <label className="text-[10px] text-gray-400">Min</label>
                <input type="text" inputMode="numeric" value={minutes} onChange={(e) => setMinutes(e.target.value)} placeholder="12" className="w-full py-1 bg-gray-700 text-white rounded text-xs text-center" />
              </div>
              <div>
                <label className="text-[10px] text-gray-400">Sec</label>
                <input type="text" inputMode="numeric" value={seconds} onChange={(e) => setSeconds(e.target.value)} placeholder="00" className="w-full py-1 bg-gray-700 text-white rounded text-xs text-center" />
              </div>
            </div>

            <button onClick={calculate} className="w-full py-2 bg-emerald-600 text-white rounded font-medium text-sm">Calculate</button>
          </div>

          {/* Results */}
          {result && (
            <div className="bg-gray-800 rounded-lg p-2 flex-1">
              <div className="grid grid-cols-3 gap-1 h-full">
                {/* Current FMV */}
                <div className="bg-gray-700 rounded p-2">
                  <div className="text-[10px] text-gray-400 mb-1">Current</div>
                  <div className="text-emerald-400 text-[10px]">{awayTeam}</div>
                  <div className="text-white font-bold text-sm">{oddsFormat === 'american' ? formatOdds(result.currentAwayOdds) : formatProb(result.currentAwayProb)}</div>
                  <div className="text-emerald-400 text-[10px] mt-1">{homeTeam}</div>
                  <div className="text-white font-bold text-sm">{oddsFormat === 'american' ? formatOdds(result.currentHomeOdds) : formatProb(result.currentHomeProb)}</div>
                </div>
                {/* If Away Scores */}
                <div className="bg-gray-700 rounded p-2">
                  <div className="text-[10px] text-gray-400 mb-1">If {awayTeam} scores</div>
                  <div className="text-emerald-400 text-[10px]">{awayTeam}</div>
                  <div className="text-emerald-400 font-bold text-sm">{oddsFormat === 'american' ? formatOdds(result.awayIfScoreOdds) : formatProb(result.awayIfScoreProb)}</div>
                  <div className="text-gray-400 text-[10px] mt-1">{homeTeam}</div>
                  <div className="text-gray-400 text-sm">{oddsFormat === 'american' ? formatOdds(probToAmerican(result.awayIfScore_HomeProb)) : formatProb(result.awayIfScore_HomeProb)}</div>
                </div>
                {/* If Home Scores */}
                <div className="bg-gray-700 rounded p-2">
                  <div className="text-[10px] text-gray-400 mb-1">If {homeTeam} scores</div>
                  <div className="text-gray-400 text-[10px]">{awayTeam}</div>
                  <div className="text-gray-400 text-sm">{oddsFormat === 'american' ? formatOdds(probToAmerican(result.homeIfScore_AwayProb)) : formatProb(result.homeIfScore_AwayProb)}</div>
                  <div className="text-emerald-400 text-[10px] mt-1">{homeTeam}</div>
                  <div className="text-emerald-400 font-bold text-sm">{oddsFormat === 'american' ? formatOdds(result.homeIfScoreOdds) : formatProb(result.homeIfScoreProb)}</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<ManualFMVCalculator />);
  </script>
</body>
</html>
